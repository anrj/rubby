<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Bubble</title>
    <style>
      @font-face {
        font-family: "PixelFont";
        src: url("./fonts/pixelfont.woff2") format("woff2");
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        image-rendering: pixelated;
      }
      body {
        background: transparent;
        font-family: "PixelFont", monospace;
        padding: 0;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        min-height: 100vh;
        overflow: hidden;
      }
      .bubble-container {
        display: grid;
        grid-template-columns: 15px 40px 1fr 15px;
        grid-template-rows: 15px 1fr 40px;
        max-width: 400px;
        min-width: 200px;
        width: fit-content;
        flex-shrink: 0;
        margin: 5px;
      }
      .corner-tl {
        grid-area: 1 / 1;
        background: url("./chatbubble/cortner_tl.png") no-repeat;
        background-size: 100% 100%;
      }
      .edge-top {
        grid-area: 1 / 2 / 1 / 4;
        background: url("./chatbubble/edge_t.png") repeat-x;
        background-size: auto 100%;
      }
      .corner-tr {
        grid-area: 1 / 4;
        background: url("./chatbubble/corner_tr.png") no-repeat;
        background-size: 100% 100%;
      }
      .edge-left {
        grid-area: 2 / 1;
        background: url("./chatbubble/edge_l.png") repeat-y;
        background-size: 100% auto;
      }
      .center {
        grid-area: 2 / 2 / 2 / 4;
        background: white;
        padding: 10px 15px;
        color: black;
        font-size: 20px;
        line-height: 1.2;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .edge-right {
        grid-area: 2 / 4;
        background: url("./chatbubble/edge_r.png") repeat-y;
        background-size: 100% auto;
      }
      .corner-bl {
        grid-area: 3 / 1;
        background: url("./chatbubble/corner_bl.png") no-repeat;
        background-size: 100% 100%;
      }
      .pointer {
        grid-area: 3 / 2;
        background: url("./chatbubble/pointer.png") no-repeat;
        background-size: 100% 100%;
      }
      .edge-bottom {
        grid-area: 3 / 3;
        background: url("./chatbubble/edge_b.png") repeat-x;
        background-size: auto 100%;
      }
      .corner-br {
        grid-area: 3 / 4;
        background: url("./chatbubble/corner_br.png") no-repeat;
        background-size: 100% 100%;
      }
    </style>
  </head>
  <body>
    <div class="bubble-container" id="bubble">
      <div class="corner-tl"></div>
      <div class="edge-top"></div>
      <div class="corner-tr"></div>
      <div class="edge-left"></div>
      <div class="center" id="text">Listening...</div>
      <div class="edge-right"></div>
      <div class="corner-bl"></div>
      <div class="pointer"></div>
      <div class="edge-bottom"></div>
      <div class="corner-br"></div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const text = params.get("text") || "â€¦";
      const id = params.get("id") || "bubble";
      document.getElementById("text").textContent = text;

      window.addEventListener("DOMContentLoaded", async () => {
        if (window.__TAURI__) {
          const { emit } = window.__TAURI__.event;
          const bubble = document.getElementById("bubble");

          const reportSize = async () => {
            const rect = bubble.getBoundingClientRect();

            const width = rect.width + 10;
            const height = rect.height + 10;

            await emit("bubble_resize", { width, height, id });
          };

          // Use ResizeObserver to detect when fonts load or layout settles
          const observer = new ResizeObserver(() => {
            reportSize();
          });
          observer.observe(bubble);

          // Also report immediately
          setTimeout(reportSize, 50);
        }
      });
    </script>
  </body>
</html>
